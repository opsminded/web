<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Graph Database Visualization</title>
    <script src="https://unpkg.com/cytoscape@3.28.1/dist/cytoscape.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
        }

        #cy {
            width: 100%;
            height: 100vh;
            background-color: #ffffff;
            border: 1px solid #ddd;
        }

        #controls {
            position: absolute;
            top: 10px;
            left: 10px;
            background: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            max-width: 250px;
        }

        #controls h3 {
            margin: 0 0 10px 0;
            font-size: 16px;
            color: #333;
        }

        #controls button {
            display: block;
            width: 100%;
            margin: 5px 0;
            padding: 8px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 14px;
        }

        #controls button:hover {
            background-color: #0056b3;
        }

        #controls select {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 14px;
        }

        #controls label {
            display: block;
            margin-top: 10px;
            margin-bottom: 5px;
            font-size: 13px;
            font-weight: bold;
            color: #555;
        }

        .category-legend {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }

        .category-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
            font-size: 12px;
        }

        .category-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 8px;
            border: 2px solid #fff;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        #info {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            font-size: 12px;
            color: #666;
        }
    </style>
</head>
<body>
    <div id="controls">
        <h3>Controls</h3>
        <button onclick="cy.fit()">Fit to Screen</button>
        <button onclick="cy.center()">Center</button>
        <button onclick="cy.reset()">Reset View</button>
        <button onclick="loadData()">Reload Data</button>

        <label for="categoryFilter">Filter by Category:</label>
        <select id="categoryFilter" onchange="filterByCategory()">
            <option value="all">All Categories</option>
        </select>

        <div class="category-legend">
            <strong style="font-size: 13px;">Categories:</strong>
            <div id="categoryLegend"></div>
        </div>
    </div>

    <div id="cy"></div>

    <div id="info">
        <strong>Nodes:</strong> <span id="nodeCount">0</span> |
        <strong>Edges:</strong> <span id="edgeCount">0</span>
    </div>

    <script>
        let cy;

        // Category color mapping
        const categoryColors = {
            'service': '#007bff',
            'database': '#28a745',
            'api': '#ffc107',
            'frontend': '#dc3545',
            'backend': '#6f42c1',
            'infrastructure': '#fd7e14',
            'default': '#6c757d'
        };

        // Status color mapping (takes precedence over category)
        const statusColors = {
            'healthy': '#28a745',     // green
            'unhealthy': '#dc3545',   // red
            'maintenance': '#ffc107', // yellow
            'unknown': '#6c757d'      // gray
        };

        // Query nodes by category
        function getNodesByCategory(category) {
            if (!cy) return [];
            if (category === 'all') {
                return cy.nodes();
            }
            return cy.nodes().filter(node => {
                const nodeCategory = node.data('category');
                return nodeCategory === category;
            });
        }

        // Get all unique categories from nodes
        function getAllCategories() {
            if (!cy) return [];
            const categories = new Set();
            cy.nodes().forEach(node => {
                const category = node.data('category');
                if (category) {
                    categories.add(category);
                }
            });
            return Array.from(categories).sort();
        }

        // Get category color
        function getCategoryColor(category) {
            return categoryColors[category] || categoryColors['default'];
        }

        // Get status color
        function getStatusColor(status) {
            return statusColors[status] || statusColors['unknown'];
        }

        // Get node color (prioritize status over category)
        function getNodeColor(node) {
            const status = node.data('status');
            const category = node.data('category');

            // If status exists, use it; otherwise fall back to category
            if (status && status !== 'unknown') {
                return getStatusColor(status);
            }
            return getCategoryColor(category);
        }

        // Filter nodes by category
        function filterByCategory() {
            const selectedCategory = document.getElementById('categoryFilter').value;

            if (selectedCategory === 'all') {
                cy.nodes().style('display', 'element');
            } else {
                cy.nodes().forEach(node => {
                    const nodeCategory = node.data('category');
                    if (nodeCategory === selectedCategory) {
                        node.style('display', 'element');
                    } else {
                        node.style('display', 'none');
                    }
                });
            }

            cy.fit();
        }

        // Update category filter dropdown and legend
        function updateCategoryUI() {
            const categories = getAllCategories();
            const filterSelect = document.getElementById('categoryFilter');
            const legendDiv = document.getElementById('categoryLegend');

            // Update filter dropdown
            filterSelect.innerHTML = '<option value="all">All Categories</option>';
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category.charAt(0).toUpperCase() + category.slice(1);
                filterSelect.appendChild(option);
            });

            // Update legend
            legendDiv.innerHTML = '';
            if (categories.length === 0) {
                legendDiv.innerHTML = '<div style="font-size: 11px; color: #999;">No categories defined</div>';
            } else {
                categories.forEach(category => {
                    const item = document.createElement('div');
                    item.className = 'category-item';
                    item.innerHTML = `
                        <div class="category-color" style="background-color: ${getCategoryColor(category)}"></div>
                        <span>${category.charAt(0).toUpperCase() + category.slice(1)}</span>
                    `;
                    legendDiv.appendChild(item);
                });
            }
        }

        async function loadData() {
            try {
                // Fetch graph structure from API
                const graphResponse = await fetch('api.php/graph');
                const graphData = await graphResponse.json();

                // Fetch node status data from API
                const statusResponse = await fetch('api.php/status');
                const statusData = await statusResponse.json();

                // Create a status map for quick lookup
                const statusMap = {};
                if (statusData.statuses) {
                    statusData.statuses.forEach(status => {
                        statusMap[status.node_id] = status.status;
                    });
                }

                // Merge status into node data
                const nodes = (graphData.nodes || []).map(node => {
                    const nodeId = node.data.id;
                    const nodeStatus = statusMap[nodeId] || 'unknown';
                    return {
                        ...node,
                        data: {
                            ...node.data,
                            status: nodeStatus
                        }
                    };
                });

                // Initialize Cytoscape
                cy = cytoscape({
                    container: document.getElementById('cy'),

                    elements: {
                        nodes: nodes,
                        edges: graphData.edges || []
                    },

                    style: [
                        {
                            selector: 'node',
                            style: {
                                'background-color': function(ele) {
                                    return getNodeColor(ele);
                                },
                                'label': function(ele) {
                                    const id = ele.data('id');
                                    const status = ele.data('status');
                                    const category = ele.data('category');

                                    let label = id;
                                    if (status) {
                                        label += `\n[${status}]`;
                                    }
                                    if (category) {
                                        label += `\n(${category})`;
                                    }
                                    return label;
                                },
                                'color': '#333',
                                'text-valign': 'center',
                                'text-halign': 'center',
                                'width': 60,
                                'height': 60,
                                'font-size': 10,
                                'text-outline-width': 2,
                                'text-outline-color': '#fff',
                                'text-wrap': 'wrap',
                                'text-max-width': '100px'
                            }
                        },
                        {
                            selector: 'edge',
                            style: {
                                'width': 3,
                                'line-color': '#ccc',
                                'target-arrow-color': '#ccc',
                                'target-arrow-shape': 'triangle',
                                'curve-style': 'bezier',
                                'label': 'data(label)',
                                'font-size': 10,
                                'text-rotation': 'autorotate',
                                'text-margin-y': -10
                            }
                        },
                        {
                            selector: 'node:selected',
                            style: {
                                'background-color': '#ffc107',
                                'border-width': 3,
                                'border-color': '#ff9800'
                            }
                        }
                    ],

                    layout: {
                        name: 'cose',
                        animate: true,
                        animationDuration: 1000,
                        nodeRepulsion: 400000,
                        idealEdgeLength: 100,
                        edgeElasticity: 100,
                        nestingFactor: 5,
                        gravity: 80,
                        numIter: 1000,
                        initialTemp: 200,
                        coolingFactor: 0.95,
                        minTemp: 1.0
                    }
                });

                // Update stats
                document.getElementById('nodeCount').textContent = cy.nodes().length;
                document.getElementById('edgeCount').textContent = cy.edges().length;

                // Add click event to nodes
                cy.on('tap', 'node', function(evt) {
                    const node = evt.target;
                    const data = node.data();
                    console.log('Node clicked:', data);

                    // If node has a URL, you can optionally open it
                    if (data.url) {
                        const openUrl = confirm(`Open ${data.url}?`);
                        if (openUrl) {
                            window.open(data.url, '_blank');
                        }
                    }
                });

                // Add hover effect
                cy.on('mouseover', 'node', function(evt) {
                    evt.target.style('background-color', '#28a745');
                });

                cy.on('mouseout', 'node', function(evt) {
                    if (!evt.target.selected()) {
                        evt.target.style('background-color', getNodeColor(evt.target));
                    }
                });

                // Update category UI after loading
                updateCategoryUI();

            } catch (error) {
                console.error('Error loading data from API:', error);
                alert('Failed to load data from API. Make sure the API is running and accessible.');
            }
        }

        // Load data on page load
        loadData();
    </script>
</body>
</html>
