<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Graph Database Visualization</title>
    <script src="/js/cytoscape.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
        }

        #cy {
            width: 100%;
            height: 100vh;
            background-color: #ffffff;
            border: 1px solid #ddd;
        }

        #controls {
            position: absolute;
            top: 10px;
            left: 10px;
            background: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            max-width: 250px;
        }

        #controls h3 {
            margin: 0 0 10px 0;
            font-size: 16px;
            color: #333;
        }

        #controls button {
            display: block;
            width: 100%;
            margin: 5px 0;
            padding: 8px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 14px;
        }

        #controls button:hover {
            background-color: #0056b3;
        }

        #controls select {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 14px;
        }

        #controls label {
            display: block;
            margin-top: 10px;
            margin-bottom: 5px;
            font-size: 13px;
            font-weight: bold;
            color: #555;
        }

        .category-legend {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }

        .category-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
            font-size: 12px;
        }

        .category-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 8px;
            border: 2px solid #fff;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        #info {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            font-size: 12px;
            color: #666;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 20px;
            color: #333;
        }

        .close {
            font-size: 28px;
            font-weight: bold;
            color: #999;
            cursor: pointer;
            line-height: 20px;
        }

        .close:hover {
            color: #333;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 14px;
            box-sizing: border-box;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 60px;
        }

        .form-group small {
            display: block;
            margin-top: 3px;
            color: #777;
            font-size: 12px;
        }

        .btn-primary {
            background-color: #28a745;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }

        .btn-primary:hover {
            background-color: #218838;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 14px;
            margin-left: 10px;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 3000;
            font-size: 14px;
            animation: slideIn 0.3s ease-out;
        }

        .notification.success {
            background-color: #28a745;
            color: white;
        }

        .notification.error {
            background-color: #dc3545;
            color: white;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .divider {
            margin: 15px 0;
            border-top: 1px solid #eee;
        }
    </style>
</head>
<body>
    <div id="controls">
        <h3>Controls</h3>
        <button onclick="openAddNodeModal()">Add Node</button>
        <button onclick="openAddEdgeModal()">Add Edge</button>

        <div class="divider"></div>

        <button onclick="cy.fit()">Fit to Screen</button>
        <button onclick="cy.center()">Center</button>
        <button onclick="cy.reset()">Reset View</button>
        <button onclick="loadData()">Reload Data</button>

        <label for="categoryFilter">Filter by Category:</label>
        <select id="categoryFilter" onchange="filterByCategory()">
            <option value="all">All Categories</option>
        </select>

        <div class="category-legend">
            <strong style="font-size: 13px;">Categories:</strong>
            <div id="categoryLegend"></div>
        </div>
    </div>

    <div id="cy"></div>

    <div id="info">
        <strong>Nodes:</strong> <span id="nodeCount">0</span> |
        <strong>Edges:</strong> <span id="edgeCount">0</span>
    </div>

    <!-- Add Node Modal -->
    <div id="addNodeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Node</h2>
                <span class="close" onclick="closeAddNodeModal()">&times;</span>
            </div>
            <form id="addNodeForm" onsubmit="return handleAddNode(event)">
                <div class="form-group">
                    <label for="nodeId">Node ID *</label>
                    <input type="text" id="nodeId" name="nodeId" required>
                    <small>Unique identifier for the node (e.g., web-server-01)</small>
                </div>
                <div class="form-group">
                    <label for="nodeCategory">Category *</label>
                    <select id="nodeCategory" name="nodeCategory" required>
                        <option value="">Select category</option>
                        <option value="business">Business</option>
                        <option value="application">Application</option>
                        <option value="infrastructure">Infrastructure</option>
                    </select>
                    <small>Determines the shape of the node</small>
                </div>
                <div class="form-group">
                    <label for="nodeType">Type *</label>
                    <select id="nodeType" name="nodeType" required>
                        <option value="">Select type</option>
                        <option value="server">Server</option>
                        <option value="database">Database</option>
                        <option value="application">Application</option>
                        <option value="network">Network</option>
                    </select>
                    <small>Determines the icon of the node</small>
                </div>
                <div class="form-group">
                    <label for="nodeLabel">Label</label>
                    <input type="text" id="nodeLabel" name="nodeLabel">
                    <small>Display label (defaults to ID if empty)</small>
                </div>
                <div class="form-group">
                    <label for="nodeUrl">URL</label>
                    <input type="url" id="nodeUrl" name="nodeUrl">
                    <small>Optional URL for this resource</small>
                </div>
                <div class="form-group">
                    <label for="nodeMetadata">Additional Metadata (JSON)</label>
                    <textarea id="nodeMetadata" name="nodeMetadata" placeholder='{"key": "value"}'></textarea>
                    <small>Optional: Additional properties as JSON</small>
                </div>
                <div>
                    <button type="submit" class="btn-primary">Create Node</button>
                    <button type="button" class="btn-secondary" onclick="closeAddNodeModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Edge Modal -->
    <div id="addEdgeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Edge</h2>
                <span class="close" onclick="closeAddEdgeModal()">&times;</span>
            </div>
            <form id="addEdgeForm" onsubmit="return handleAddEdge(event)">
                <div class="form-group">
                    <label for="edgeId">Edge ID *</label>
                    <input type="text" id="edgeId" name="edgeId" required>
                    <small>Unique identifier for the edge</small>
                </div>
                <div class="form-group">
                    <label for="edgeSource">Source Node *</label>
                    <input type="text" id="edgeSource" name="edgeSource" required list="nodeList">
                    <datalist id="nodeList"></datalist>
                    <small>Source node ID</small>
                </div>
                <div class="form-group">
                    <label for="edgeTarget">Target Node *</label>
                    <input type="text" id="edgeTarget" name="edgeTarget" required list="nodeList">
                    <small>Target node ID</small>
                </div>
                <div class="form-group">
                    <label for="edgeLabel">Label</label>
                    <input type="text" id="edgeLabel" name="edgeLabel">
                    <small>Relationship label (e.g., "depends on", "connects to")</small>
                </div>
                <div class="form-group">
                    <label for="edgeMetadata">Additional Metadata (JSON)</label>
                    <textarea id="edgeMetadata" name="edgeMetadata" placeholder='{"key": "value"}'></textarea>
                    <small>Optional: Additional properties as JSON</small>
                </div>
                <div>
                    <button type="submit" class="btn-primary">Create Edge</button>
                    <button type="button" class="btn-secondary" onclick="closeAddEdgeModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let cy;

        // Authentication credentials (can be set via browser prompt)
        // For production, implement proper authentication management
        let authCredentials = null;

        // Get auth credentials (prompt user if not set)
        function getAuthHeader() {
            if (!authCredentials) {
                const username = prompt('Enter username (default: admin):', 'admin');
                if (!username) return null;

                const password = prompt('Enter password (default: password):', 'password');
                if (!password) return null;

                authCredentials = btoa(username + ':' + password);
            }
            return 'Basic ' + authCredentials;
        }

        // Category shape mapping
        const categoryShapes = {
            'business': 'ellipse',
            'application': 'round-rectangle',
            'infrastructure': 'diamond'
        };

        // Category color mapping (fallback when no status)
        const categoryColors = {
            'business': '#007bff',      // blue
            'application': '#28a745',   // green
            'infrastructure': '#fd7e14', // orange
            'default': '#6c757d'
        };

        // Status color mapping (takes precedence over category)
        const statusColors = {
            'healthy': '#28a745',     // green
            'unhealthy': '#dc3545',   // red
            'maintenance': '#ffc107', // yellow
            'unknown': '#6c757d'      // gray
        };

        // Query nodes by category
        function getNodesByCategory(category) {
            if (!cy) return [];
            if (category === 'all') {
                return cy.nodes();
            }
            return cy.nodes().filter(node => {
                const nodeCategory = node.data('category');
                return nodeCategory === category;
            });
        }

        // Get all unique categories from nodes
        function getAllCategories() {
            if (!cy) return [];
            const categories = new Set();
            cy.nodes().forEach(node => {
                const category = node.data('category');
                if (category) {
                    categories.add(category);
                }
            });
            return Array.from(categories).sort();
        }

        // Get category color
        function getCategoryColor(category) {
            return categoryColors[category] || categoryColors['default'];
        }

        // Get status color
        function getStatusColor(status) {
            return statusColors[status] || statusColors['unknown'];
        }

        // Get node color (prioritize status over category)
        function getNodeColor(node) {
            const status = node.data('status');
            const category = node.data('category');

            // If status exists, use it; otherwise fall back to category
            if (status && status !== 'unknown') {
                return getStatusColor(status);
            }
            return getCategoryColor(category);
        }

        // Filter nodes by category
        function filterByCategory() {
            const selectedCategory = document.getElementById('categoryFilter').value;

            if (selectedCategory === 'all') {
                cy.nodes().style('display', 'element');
            } else {
                cy.nodes().forEach(node => {
                    const nodeCategory = node.data('category');
                    if (nodeCategory === selectedCategory) {
                        node.style('display', 'element');
                    } else {
                        node.style('display', 'none');
                    }
                });
            }

            cy.fit();
        }

        // Update category filter dropdown and legend
        function updateCategoryUI() {
            const categories = getAllCategories();
            const filterSelect = document.getElementById('categoryFilter');
            const legendDiv = document.getElementById('categoryLegend');

            // Update filter dropdown
            filterSelect.innerHTML = '<option value="all">All Categories</option>';
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category.charAt(0).toUpperCase() + category.slice(1);
                filterSelect.appendChild(option);
            });

            // Update legend
            legendDiv.innerHTML = '';
            if (categories.length === 0) {
                legendDiv.innerHTML = '<div style="font-size: 11px; color: #999;">No categories defined</div>';
            } else {
                categories.forEach(category => {
                    const item = document.createElement('div');
                    item.className = 'category-item';
                    item.innerHTML = `
                        <div class="category-color" style="background-color: ${getCategoryColor(category)}"></div>
                        <span>${category.charAt(0).toUpperCase() + category.slice(1)}</span>
                    `;
                    legendDiv.appendChild(item);
                });
            }
        }

        async function loadData() {
            try {
                // Fetch graph structure from API
                const graphResponse = await fetch('api.php/graph');
                const graphData = await graphResponse.json();

                // Fetch node status data from API
                const statusResponse = await fetch('api.php/status');
                const statusData = await statusResponse.json();

                // Create a status map for quick lookup
                const statusMap = {};
                if (statusData.statuses) {
                    statusData.statuses.forEach(status => {
                        statusMap[status.node_id] = status.status;
                    });
                }

                // Merge status into node data
                const nodes = (graphData.nodes || []).map(node => {
                    const nodeId = node.data.id;
                    const nodeStatus = statusMap[nodeId] || 'unknown';
                    return {
                        ...node,
                        data: {
                            ...node.data,
                            status: nodeStatus
                        }
                    };
                });

                // Initialize Cytoscape
                cy = cytoscape({
                    container: document.getElementById('cy'),

                    elements: {
                        nodes: nodes,
                        edges: graphData.edges || []
                    },

                    style: [
                        {
                            selector: 'node',
                            style: {
                                'shape': function(ele) {
                                    const category = ele.data('category');
                                    return categoryShapes[category] || 'ellipse';
                                },
                                'background-color': function(ele) {
                                    return getNodeColor(ele);
                                },
                                'background-image': function(ele) {
                                    const type = ele.data('type');
                                    const status = ele.data('status') || 'unknown';
                                    if (type && status) {
                                        return `img/${type}-${status}.png`;
                                    }
                                    return 'none';
                                },
                                'background-fit': 'contain',
                                'background-image-opacity': 0.8,
                                'label': function(ele) {
                                    const id = ele.data('id');
                                    const status = ele.data('status');
                                    const category = ele.data('category');
                                    const type = ele.data('type');

                                    let label = id;
                                    if (status) {
                                        label += `\n[${status}]`;
                                    }
                                    if (type) {
                                        label += `\n{${type}}`;
                                    }
                                    return label;
                                },
                                'color': '#333',
                                'text-valign': 'bottom',
                                'text-halign': 'center',
                                'text-margin-y': 5,
                                'width': 80,
                                'height': 80,
                                'font-size': 10,
                                'text-outline-width': 2,
                                'text-outline-color': '#fff',
                                'text-wrap': 'wrap',
                                'text-max-width': '120px'
                            }
                        },
                        {
                            selector: 'edge',
                            style: {
                                'width': 3,
                                'line-color': '#ccc',
                                'target-arrow-color': '#ccc',
                                'target-arrow-shape': 'triangle',
                                'curve-style': 'bezier',
                                'label': 'data(label)',
                                'font-size': 10,
                                'text-rotation': 'autorotate',
                                'text-margin-y': -10
                            }
                        },
                        {
                            selector: 'node:selected',
                            style: {
                                'background-color': '#ffc107',
                                'border-width': 3,
                                'border-color': '#ff9800'
                            }
                        }
                    ],

                    layout: {
                        name: 'cose',
                        animate: true,
                        animationDuration: 1000,
                        nodeRepulsion: 400000,
                        idealEdgeLength: 100,
                        edgeElasticity: 100,
                        nestingFactor: 5,
                        gravity: 80,
                        numIter: 1000,
                        initialTemp: 200,
                        coolingFactor: 0.95,
                        minTemp: 1.0
                    }
                });

                // Update stats
                document.getElementById('nodeCount').textContent = cy.nodes().length;
                document.getElementById('edgeCount').textContent = cy.edges().length;

                // Add click event to nodes
                cy.on('tap', 'node', function(evt) {
                    const node = evt.target;
                    const data = node.data();
                    console.log('Node clicked:', data);

                    // If node has a URL, you can optionally open it
                    if (data.url) {
                        const openUrl = confirm(`Open ${data.url}?`);
                        if (openUrl) {
                            window.open(data.url, '_blank');
                        }
                    }
                });

                // Add hover effect
                cy.on('mouseover', 'node', function(evt) {
                    evt.target.style('background-color', '#28a745');
                });

                cy.on('mouseout', 'node', function(evt) {
                    if (!evt.target.selected()) {
                        evt.target.style('background-color', getNodeColor(evt.target));
                    }
                });

                // Update category UI after loading
                updateCategoryUI();

            } catch (error) {
                console.error('Error loading data from API:', error);
                alert('Failed to load data from API. Make sure the API is running and accessible.');
            }
        }

        // Modal functions
        function openAddNodeModal() {
            document.getElementById('addNodeModal').style.display = 'block';
            document.getElementById('addNodeForm').reset();
        }

        function closeAddNodeModal() {
            document.getElementById('addNodeModal').style.display = 'none';
        }

        function openAddEdgeModal() {
            // Populate node list for autocomplete
            updateNodeList();
            document.getElementById('addEdgeModal').style.display = 'block';
            document.getElementById('addEdgeForm').reset();
        }

        function closeAddEdgeModal() {
            document.getElementById('addEdgeModal').style.display = 'none';
        }

        // Update node list for edge creation
        function updateNodeList() {
            const nodeList = document.getElementById('nodeList');
            nodeList.innerHTML = '';

            if (cy) {
                cy.nodes().forEach(node => {
                    const option = document.createElement('option');
                    option.value = node.data('id');
                    nodeList.appendChild(option);
                });
            }
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const nodeModal = document.getElementById('addNodeModal');
            const edgeModal = document.getElementById('addEdgeModal');

            if (event.target === nodeModal) {
                closeAddNodeModal();
            }
            if (event.target === edgeModal) {
                closeAddEdgeModal();
            }
        }

        // Show notification
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Handle node creation
        async function handleAddNode(event) {
            event.preventDefault();

            const nodeId = document.getElementById('nodeId').value.trim();
            const category = document.getElementById('nodeCategory').value;
            const type = document.getElementById('nodeType').value;
            const label = document.getElementById('nodeLabel').value.trim();
            const url = document.getElementById('nodeUrl').value.trim();
            const metadataStr = document.getElementById('nodeMetadata').value.trim();

            // Build node data
            const nodeData = {
                id: nodeId,
                category: category,
                type: type,
                label: label || nodeId
            };

            if (url) {
                nodeData.url = url;
            }

            // Parse additional metadata
            if (metadataStr) {
                try {
                    const metadata = JSON.parse(metadataStr);
                    Object.assign(nodeData, metadata);
                } catch (e) {
                    showNotification('Invalid JSON in metadata field', 'error');
                    return false;
                }
            }

            try {
                const authHeader = getAuthHeader();
                if (!authHeader) {
                    showNotification('Authentication cancelled', 'error');
                    return false;
                }

                const response = await fetch('api.php/nodes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': authHeader
                    },
                    body: JSON.stringify({
                        id: nodeId,
                        data: nodeData
                    })
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    showNotification(`Node "${nodeId}" created successfully!`, 'success');
                    closeAddNodeModal();
                    loadData(); // Reload graph
                } else {
                    showNotification(result.message || result.error || 'Failed to create node', 'error');
                }
            } catch (error) {
                console.error('Error creating node:', error);
                showNotification('Network error: ' + error.message, 'error');
            }

            return false;
        }

        // Handle edge creation
        async function handleAddEdge(event) {
            event.preventDefault();

            const edgeId = document.getElementById('edgeId').value.trim();
            const source = document.getElementById('edgeSource').value.trim();
            const target = document.getElementById('edgeTarget').value.trim();
            const label = document.getElementById('edgeLabel').value.trim();
            const metadataStr = document.getElementById('edgeMetadata').value.trim();

            // Build edge data
            const edgeData = {
                id: edgeId,
                source: source,
                target: target
            };

            if (label) {
                edgeData.label = label;
            }

            // Parse additional metadata
            if (metadataStr) {
                try {
                    const metadata = JSON.parse(metadataStr);
                    Object.assign(edgeData, metadata);
                } catch (e) {
                    showNotification('Invalid JSON in metadata field', 'error');
                    return false;
                }
            }

            try {
                const authHeader = getAuthHeader();
                if (!authHeader) {
                    showNotification('Authentication cancelled', 'error');
                    return false;
                }

                const response = await fetch('api.php/edges', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': authHeader
                    },
                    body: JSON.stringify({
                        id: edgeId,
                        source: source,
                        target: target,
                        data: edgeData
                    })
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    showNotification(`Edge "${edgeId}" created successfully!`, 'success');
                    closeAddEdgeModal();
                    loadData(); // Reload graph
                } else {
                    showNotification(result.message || result.error || 'Failed to create edge', 'error');
                }
            } catch (error) {
                console.error('Error creating edge:', error);
                showNotification('Network error: ' + error.message, 'error');
            }

            return false;
        }

        // Load data on page load
        loadData();
    </script>
</body>
</html>
